[![pipeline status](https://gitlab.com/rechat/web/badges/stage/pipeline.svg)](https://gitlab.com/rechat/web/commits/stage)
[![coverage report](https://gitlab.com/rechat/web/badges/stage/coverage.svg)](https://gitlab.com/rechat/web/commits/stage)

[![Production Status](https://img.shields.io/website/https/rechat.com.svg?label=production&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAABGdBTUEAALGPC%2FxhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA%2FwD%2FAP%2BgvaeTAAAAB3RJTUUH4wcDFRAvB2%2F%2B4QAAAzVJREFUSMe1lW9oVXUYxz%2FP756zF6mpu8GWlm1sVKOEtphZRhAUkm8GFeRbCyuIEHoVGPZnDHpVQYik%2BKqMQCipGUR%2FrEZSE5aZy2G65mw1Xfdm0%2B3e7d7z%2B%2FbinPt3VljrCw%2Fnz%2FM7n%2BfPeX7nGHfkAEJgE%2FA40AU0JveMf5aAApAFhoDdwIdAwViXC4CnMHYk0P%2BqLOIlYKfRnevB2AukFwFcUgbxWIDYushggDRia4DoQouMjtUVoErWKQfOVbkFxSJIgLtieDpAhBCPxbZHAu5b74iihC0YnxT7P44Y%2BNbjrwweBghDMb3zJuOBuxem%2BPD9jid7Cxw45OMKlFgpmrtsZRaUF1T1fSor9n%2FkCUPoudfRlDae3hzwydfzXJoFZ9C62ri51SgUYfiUmJjSgl1RgVslwC%2FnxI5XC2QvQtAXsuXBFC2rjZVLjUszYktPiu1PBNywyog8nDgttr9WoH%2FA1wQIyhmrAl%2B53HhoYwqXgjtvi%2Bs9nxF%2FTIvuDkfftoDGFcbng55lS6B7rePlZ0KOn5pnbELlFgVlaFXENauMN3pDJDCD7AWx6%2B2I6Quw8S5H0zXG8ZPihdeLNKWNXS8aHW3G%2BrWOsfGozKrteZL5xRkYOys62o0ggH3ve%2FZ9EIGD65vjJ29sMd7bGeIMrl5qOAfN6eQl%2B3p4lX4a9zz6bIHdfSFdtzo2dBnNaWNiUuTn4jW%2Fnhfv9EfMFaAhAC8YPJZk50tDpKqsVSli9Kx460CEBJ23ODZvSkERvh%2FxSLDkKjj3mzg2IpYvMwaOeA4P%2BcpgCKA9J9pysvac3ny3KEn67odIjZ05rdmQ1%2FBJL0k68aNXyz15Na%2FL69DhSPX67KtI6dvzoi0n2mNLseK55wEzQVOjMTML3xwVXwx6prIwOwO5PExMitEzYnhEfHnEk%2F0dpqfF6TPQ%2F2nEK3sjRn9WdRdktObmgIbSqNdUlewLKzmIe4uPfUFD7CvOJ9%2BfVM2rmw%2FwZIBr6wamLJE8uGBzQ7FQe103HBkHDP0ltSZCXXT9zbpYQw6xB5Epf4hKprrzavOXOfoafwaxxyEOAr2I7ALIv7NswjtoXPf%2F%2Ff3%2FBE6QqvFOmYLKAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTA3LTAzVDIxOjE2OjQ3LTA0OjAwX1rUJwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wNy0wM1QyMToxNjo0Ny0wNDowMC4HbJsAAAAASUVORK5CYII%3D)](https://rechat.com)
[![Irish Status](https://img.shields.io/website/https/irish.rechat.com.svg?label=irish&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAABGdBTUEAALGPC%2FxhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA%2FwD%2FAP%2BgvaeTAAAAB3RJTUUH4wcDFRAvB2%2F%2B4QAAAzVJREFUSMe1lW9oVXUYxz%2FP756zF6mpu8GWlm1sVKOEtphZRhAUkm8GFeRbCyuIEHoVGPZnDHpVQYik%2BKqMQCipGUR%2FrEZSE5aZy2G65mw1Xfdm0%2B3e7d7z%2B%2FbinPt3VljrCw%2Fnz%2FM7n%2BfPeX7nGHfkAEJgE%2FA40AU0JveMf5aAApAFhoDdwIdAwViXC4CnMHYk0P%2BqLOIlYKfRnevB2AukFwFcUgbxWIDYushggDRia4DoQouMjtUVoErWKQfOVbkFxSJIgLtieDpAhBCPxbZHAu5b74iihC0YnxT7P44Y%2BNbjrwweBghDMb3zJuOBuxem%2BPD9jid7Cxw45OMKlFgpmrtsZRaUF1T1fSor9n%2FkCUPoudfRlDae3hzwydfzXJoFZ9C62ri51SgUYfiUmJjSgl1RgVslwC%2FnxI5XC2QvQtAXsuXBFC2rjZVLjUszYktPiu1PBNywyog8nDgttr9WoH%2FA1wQIyhmrAl%2B53HhoYwqXgjtvi%2Bs9nxF%2FTIvuDkfftoDGFcbng55lS6B7rePlZ0KOn5pnbELlFgVlaFXENauMN3pDJDCD7AWx6%2B2I6Quw8S5H0zXG8ZPihdeLNKWNXS8aHW3G%2BrWOsfGozKrteZL5xRkYOys62o0ggH3ve%2FZ9EIGD65vjJ29sMd7bGeIMrl5qOAfN6eQl%2B3p4lX4a9zz6bIHdfSFdtzo2dBnNaWNiUuTn4jW%2Fnhfv9EfMFaAhAC8YPJZk50tDpKqsVSli9Kx460CEBJ23ODZvSkERvh%2FxSLDkKjj3mzg2IpYvMwaOeA4P%2BcpgCKA9J9pysvac3ny3KEn67odIjZ05rdmQ1%2FBJL0k68aNXyz15Na%2FL69DhSPX67KtI6dvzoi0n2mNLseK55wEzQVOjMTML3xwVXwx6prIwOwO5PExMitEzYnhEfHnEk%2F0dpqfF6TPQ%2F2nEK3sjRn9WdRdktObmgIbSqNdUlewLKzmIe4uPfUFD7CvOJ9%2BfVM2rmw%2FwZIBr6wamLJE8uGBzQ7FQe103HBkHDP0ltSZCXXT9zbpYQw6xB5Epf4hKprrzavOXOfoafwaxxyEOAr2I7ALIv7NswjtoXPf%2F%2Ff3%2FBE6QqvFOmYLKAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTA3LTAzVDIxOjE2OjQ3LTA0OjAwX1rUJwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wNy0wM1QyMToxNjo0Ny0wNDowMC4HbJsAAAAASUVORK5CYII%3D)](https://irish.rechat.com)
[![Alpha Status](https://img.shields.io/website/https/alpha.rechat.com.svg?label=alpha&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAABGdBTUEAALGPC%2FxhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA%2FwD%2FAP%2BgvaeTAAAAB3RJTUUH4wcDFRAvB2%2F%2B4QAAAzVJREFUSMe1lW9oVXUYxz%2FP756zF6mpu8GWlm1sVKOEtphZRhAUkm8GFeRbCyuIEHoVGPZnDHpVQYik%2BKqMQCipGUR%2FrEZSE5aZy2G65mw1Xfdm0%2B3e7d7z%2B%2FbinPt3VljrCw%2Fnz%2FM7n%2BfPeX7nGHfkAEJgE%2FA40AU0JveMf5aAApAFhoDdwIdAwViXC4CnMHYk0P%2BqLOIlYKfRnevB2AukFwFcUgbxWIDYushggDRia4DoQouMjtUVoErWKQfOVbkFxSJIgLtieDpAhBCPxbZHAu5b74iihC0YnxT7P44Y%2BNbjrwweBghDMb3zJuOBuxem%2BPD9jid7Cxw45OMKlFgpmrtsZRaUF1T1fSor9n%2FkCUPoudfRlDae3hzwydfzXJoFZ9C62ri51SgUYfiUmJjSgl1RgVslwC%2FnxI5XC2QvQtAXsuXBFC2rjZVLjUszYktPiu1PBNywyog8nDgttr9WoH%2FA1wQIyhmrAl%2B53HhoYwqXgjtvi%2Bs9nxF%2FTIvuDkfftoDGFcbng55lS6B7rePlZ0KOn5pnbELlFgVlaFXENauMN3pDJDCD7AWx6%2B2I6Quw8S5H0zXG8ZPihdeLNKWNXS8aHW3G%2BrWOsfGozKrteZL5xRkYOys62o0ggH3ve%2FZ9EIGD65vjJ29sMd7bGeIMrl5qOAfN6eQl%2B3p4lX4a9zz6bIHdfSFdtzo2dBnNaWNiUuTn4jW%2Fnhfv9EfMFaAhAC8YPJZk50tDpKqsVSli9Kx460CEBJ23ODZvSkERvh%2FxSLDkKjj3mzg2IpYvMwaOeA4P%2BcpgCKA9J9pysvac3ny3KEn67odIjZ05rdmQ1%2FBJL0k68aNXyz15Na%2FL69DhSPX67KtI6dvzoi0n2mNLseK55wEzQVOjMTML3xwVXwx6prIwOwO5PExMitEzYnhEfHnEk%2F0dpqfF6TPQ%2F2nEK3sjRn9WdRdktObmgIbSqNdUlewLKzmIe4uPfUFD7CvOJ9%2BfVM2rmw%2FwZIBr6wamLJE8uGBzQ7FQe103HBkHDP0ltSZCXXT9zbpYQw6xB5Epf4hKprrzavOXOfoafwaxxyEOAr2I7ALIv7NswjtoXPf%2F%2Ff3%2FBE6QqvFOmYLKAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTA3LTAzVDIxOjE2OjQ3LTA0OjAwX1rUJwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wNy0wM1QyMToxNjo0Ny0wNDowMC4HbJsAAAAASUVORK5CYII%3D)](https://alpha.rechat.com)

# Rechat Web App

##### Stack

This is the Rechat application for Web (Desktop version). It is a universal React application that renders both on the server side and on the client side.

It uses the following:
1. [Koa](https://koajs.com) for server side rendering
2. [React](https://facebook.github.io/react/) for UI views
3. [Redux](https://github.com/reactjs/redux) for state managing

##### Install
```bash
git clone git@gitlab.com:rechat/web.git
cd web
npm install
```

##### Start Dev Server
```bash
npm run develop
```
Go to [http://localhost:8080](http://localhost:8080)


##### Run unit tests in watch mode
```bash
npm test
```

##### Run unit tests
```bash
npm run test:unit
```

## E2E tests

Cypress is used for end to end testing. A local version of API is used for e2e
tests which uses a suitable dump of the database as test data.

### 1. Pre-requisites
The following requirements should be met on the machine that runs e2e tests.

- [docker-compose][docker-compose] should be installed. It's required for 
  running e2e api server.
- You should also be logged in to Gitlab docker registery to pull private images. This can be done by running `docker login registry.gitlab.com` command.
- `recommended` - Heroku cli should be installed and logged in with an account 
  which has access to [rechat-irish](heroku-irish) application.

### 2. Setting up e2e test servers
In order to run e2e tests, e2e API server and an instance of web app (which is
running on port **8081** and is configured to connect to e2e API server) should be
up and running.

#### Running e2e API server
- Ensure `.env` file exists in [/tests/services/api](/tests/services/api) 
  directory. If [you have heroku installed](#1-pre-requisites) you can run
  `npm run e2e:api:fetch-config` to create/update it.
- Run `npm run e2e:api:start`

#### Running e2e web app
You can either run e2e web app in dev mode, or build it for CI environment.
and serve it
##### - Run in dev mode
- Run `npm run e2e:server:start`. IMPORTANT: make sure you have appropriate
  `development.js` configuration files which use e2e api server address
  if `E2E` environment variable is set.
##### - Build and run
- `npm run build:ci`
- `npm run serve:ci`

There's also a shortcut for running `npm run e2e:api:start` and
`npm run e2e:server:start`:

```bash
npm run e2e:start
```

### 3. Run e2e tests:
When e2e API server and e2e web app are up, you can open cypress with:

```bash
npm run cypress
```

Or you can run all e2e tests once:
```bash
npm run test:e2e
```

### Test data
In each run of the e2e test api server, a clean database is seeded with
[test-data.sql](/tests/services/db/test-data.sql) file. So tests can freely
mutate the state of the database in tests without worrying about subsequent 
runs of the tests. In order to update the test data all you need to do is to 
[start e2e servers](#2-setting-up-e2e-test-servers), create the desired state
via the UI, and then run the following command:

```bash
npm run e2e:update-db
```

This will update the test-data.sql file in `/tests/services/db/data`.

### Sandboxing
Spec-level isolation is provided by means of a custom cypress command: `sandbox`. 
It's recommended to use it in all test suites this way:
```javascript
beforeEach(() => {
  cy.sandbox()
})
```

With this command, all http requests are enriched with `x-suite` header equal to
spec file path.

The api server creates a separate connection for each unique value of the 
`x-suite` header and runs all database queries of the requests with the same 
`x-suite` header within a single transaction in that same connection.
This way, state modifications of different test suites are isolated from 
each other. This enables ability of running multiple test suites **in parallel**
without flakiness.

### API image version
By default, API image with tag `testing` is pulled from the 
[container registry][container-registry]. This can be changed by setting
`API_IMAGE_TAG` environment variable when 
[running e2e api server](#running-e2e-api-server).

This is particularly useful when some branch depends on an specific
branches of the API. In this case the `e2e:api:start` can be changed to 
set appropriate value of the `API_IMAGE_TAG` environment variable.

You can also update (pull the latest version of) the api image by running:

```bash
npm run e2e:api:update-image
```


[heroku-irish]: https://dashboard.heroku.com/apps/rechat-irish
[docker-compose]: https://docs.docker.com/compose/install/
[container-registry]: https://gitlab.com/rechat/server/container_registry
