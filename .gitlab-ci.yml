image: node:14-alpine

stages:
  - deps
  - tests
  - deploy

variables:
  CONTAINER_IMAGE: registry.gitlab.com/rechat/web:$CI_COMMIT_REF_NAME

# docker:
#   stage: build
#   only:
#     - build
#
#   script:
#     - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
#     - docker build -t $CONTAINER_IMAGE .
#     - docker push $CONTAINER_IMAGE

deps:
  stage: deps
  script:
    - docker build --target deps .
  tags:
    - shell

jest:
  stage: tests
  script:
    - docker build --target deps . -t web-tests
    - docker run -t web 'npm' 'run' 'test:ci'
  tags:
    - shell
  needs:
    - deps

eslint:
  stage: tests
  script:
    - docker build --target deps . -t web-tests
    - docker run -t web 'npm' 'run' 'lint:ci'
  tags:
    - shell
  needs:
    - deps

typescript:
  stage: tests
  script:
    - docker build --target deps . -t web-tests
    - docker run -t web 'npm' 'run' 'types:check'
  tags:
    - shell
  needs:
    - deps

alpha:
  stage: deploy
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: https://$CI_COMMIT_REF_SLUG.rechat.co/
  script:
    - docker build --target deps . -t web
  only:
    - merge_requests
  except:
    - master
  tags:
    - shell
  needs:
    - deps
