image: node:14-alpine

stages:
  - deps
  - tests
  - deploy

deps:
  stage: deps
  script:
    - docker build --target deps .
  tags:
    - shell

jest:
  stage: tests
  script:
    - docker build --target deps . -t $CI_COMMIT_REF_NAME-jest
    - docker run -t $CI_COMMIT_REF_NAME-jest 'npm' 'run' 'test:ci'
  tags:
    - shell
  needs:
    - deps

eslint:
  stage: tests
  script:
    - docker build --target deps . -t $CI_COMMIT_REF_NAME-eslint
    - docker run -t $CI_COMMIT_REF_NAME-eslint 'npm' 'run' 'lint:ci'
  tags:
    - shell
  needs:
    - deps

typescript:
  stage: tests
  script:
    - docker build --target deps . -t $CI_COMMIT_REF_NAME-typescript
    - docker run -t $CI_COMMIT_REF_NAME-typescript 'npm' 'run' 'types:check'
  tags:
    - shell
  needs:
    - deps

alpha:
  stage: deploy
  script:
    - ./dokku.sh

  needs:
    - deps
  tags:
    - shell
